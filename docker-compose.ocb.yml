# =============================================================================
# TelemetryFlow Collector - Docker Compose (OCB Build)
# =============================================================================
#
# TelemetryFlow Collector - Community Enterprise Observability Platform (CEOP)
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# This docker-compose uses the OCB build (Dockerfile.ocb)
# For standalone build, use docker-compose.yml
#
# Usage:
#   # Start with default .env
#   docker-compose -f docker-compose.ocb.yml up -d
#
#   # Build and start
#   docker-compose -f docker-compose.ocb.yml up -d --build
#
#   # View logs
#   docker-compose -f docker-compose.ocb.yml logs -f tfo-collector-ocb
#
#   # Stop
#   docker-compose -f docker-compose.ocb.yml down
#
# =============================================================================

services:
  tfo-collector-ocb:
    container_name: ${CONTAINER_NAME_OCB:-tfo-collector-ocb}
    image: ${IMAGE_NAME_OCB:-telemetryflow/telemetryflow-collector-ocb}:${IMAGE_TAG_OCB:-1.1.1}
    build:
      context: .
      dockerfile: Dockerfile.ocb
      args:
        VERSION: ${VERSION:-1.1.1}
        OTEL_VERSION: ${OTEL_VERSION:-0.142.0}
    hostname: ${COLLECTOR_ID:-tfo-collector-ocb}
    restart: unless-stopped

    # Environment variables
    environment:
      - TELEMETRYFLOW_API_ENDPOINT=${TELEMETRYFLOW_API_ENDPOINT:-http://localhost:3100}
      - TELEMETRYFLOW_TENANT_ID=${TELEMETRYFLOW_TENANT_ID:-default}
      - TELEMETRYFLOW_WORKSPACE_ID=${TELEMETRYFLOW_WORKSPACE_ID:-default}
      - OTLP_EXPORTER_ENDPOINT=${OTLP_EXPORTER_ENDPOINT:-}
      - LOKI_ENDPOINT=${LOKI_ENDPOINT:-}

    # Port mappings
    ports:
      - "${OTLP_GRPC_PORT:-4317}:4317"               # OTLP gRPC
      - "${OTLP_HTTP_PORT:-4318}:4318"               # OTLP HTTP
      - "${METRICS_PORT:-8888}:8888"                 # Prometheus metrics (self)
      - "${PROMETHEUS_EXPORTER_PORT:-8889}:8889"    # Prometheus exporter
      - "${HEALTH_PORT:-13133}:13133"                # Health check
      - "${ZPAGES_PORT:-55679}:55679"                # zPages
      - "${PPROF_PORT:-1777}:1777"                   # pprof

    # Volume mounts
    volumes:
      - ./configs/otel-collector.yaml:/etc/tfo-collector/otel-collector.yaml:ro
      - tfo-collector-ocb-queue:/var/lib/tfo-collector
      - tfo-collector-ocb-logs:/var/log/tfo-collector

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-2G}
          cpus: "${CPU_LIMIT:-2.0}"
        reservations:
          memory: 512M
          cpus: "0.5"

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Network
    networks:
      - telemetryflow

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  tfo-collector-ocb-queue:
    driver: local
  tfo-collector-ocb-logs:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  telemetryflow:
    driver: bridge
    name: telemetryflow-network
