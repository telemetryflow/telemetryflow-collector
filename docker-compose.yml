# =============================================================================
# TelemetryFlow Collector - Docker Compose (OCB Native Build)
# =============================================================================
#
# TelemetryFlow Collector - Community Enterprise Observability Platform (CEOP)
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# This docker-compose uses the OCB Native build with TFO components.
#
# Usage:
#   # Start with default .env
#   docker-compose up -d
#
#   # Build and start
#   docker-compose up -d --build
#
#   # View logs
#   docker-compose logs -f tfo-collector
#
#   # Stop
#   docker-compose down
#
# =============================================================================
# OTLP HTTP Endpoints (v1 + v2 on same port 4318)
# =============================================================================
#
#   v1 Endpoints (Community/Open - NO AUTH REQUIRED):
#     POST http://localhost:4318/v1/traces
#     POST http://localhost:4318/v1/metrics
#     POST http://localhost:4318/v1/logs
#
#   v2 Endpoints (TFO Platform - AUTH REQUIRED):
#     Headers: X-TelemetryFlow-Key-ID, X-TelemetryFlow-Key-Secret
#     POST http://localhost:4318/v2/traces
#     POST http://localhost:4318/v2/metrics
#     POST http://localhost:4318/v2/logs
#
#   gRPC (Both versions via same port):
#     localhost:4317
#
# =============================================================================

services:
  tfo-collector:
    container_name: ${CONTAINER_NAME:-tfo-collector}
    image: ${IMAGE_NAME:-telemetryflow/telemetryflow-collector}:${IMAGE_TAG:-1.1.2}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-1.1.2}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_BRANCH: ${GIT_BRANCH:-main}
        BUILD_TIME: ${BUILD_TIME:-unknown}
        OTEL_VERSION: ${OTEL_VERSION:-0.142.0}
    hostname: ${TELEMETRYFLOW_COLLECTOR_NAME:-tfo-collector}
    restart: unless-stopped

    # Environment variables for TFO components
    environment:
      # TFO Auth Extension (tfoauth)
      - TELEMETRYFLOW_API_KEY_ID=${TELEMETRYFLOW_API_KEY_ID:-}
      - TELEMETRYFLOW_API_KEY_SECRET=${TELEMETRYFLOW_API_KEY_SECRET:-}
      - TELEMETRYFLOW_ENDPOINT=${TELEMETRYFLOW_ENDPOINT:-https://api.telemetryflow.id}
      # TFO Identity Extension (tfoidentity)
      - TELEMETRYFLOW_COLLECTOR_ID=${TELEMETRYFLOW_COLLECTOR_ID:-}
      - TELEMETRYFLOW_COLLECTOR_NAME=${TELEMETRYFLOW_COLLECTOR_NAME:-TelemetryFlow Collector}
      - TELEMETRYFLOW_ENVIRONMENT=${TELEMETRYFLOW_ENVIRONMENT:-production}
      - TELEMETRYFLOW_DATACENTER=${TELEMETRYFLOW_DATACENTER:-default}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

    # Port mappings
    ports:
      - "${OTLP_GRPC_PORT:-4317}:4317"               # OTLP gRPC
      - "${OTLP_HTTP_PORT:-4318}:4318"               # OTLP HTTP (v1 + v2)
      - "${METRICS_PORT:-8888}:8888"                 # Prometheus metrics (self)
      - "${PROMETHEUS_EXPORTER_PORT:-8889}:8889"    # Prometheus exporter
      - "${HEALTH_PORT:-13133}:13133"                # Health check
      - "${ZPAGES_PORT:-55679}:55679"                # zPages
      - "${PPROF_PORT:-1777}:1777"                   # pprof

    # Volume mounts
    volumes:
      - ./configs/tfo-collector.yaml:/etc/tfo-collector/tfo-collector.yaml:ro
      - tfo-collector-queue:/var/lib/tfo-collector
      - tfo-collector-logs:/var/log/tfo-collector

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:13133/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-2G}
          cpus: "${CPU_LIMIT:-2.0}"
        reservations:
          memory: 512M
          cpus: "0.5"

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Network
    networks:
      - telemetryflow

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  tfo-collector-queue:
    driver: local
  tfo-collector-logs:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  telemetryflow:
    driver: bridge
    name: telemetryflow-network
