# =============================================================================
# TelemetryFlow Collector - OCB Release Workflow
# =============================================================================
#
# TelemetryFlow Collector - Community Enterprise Observability Platform (CEOP)
# Copyright (c) 2024-2026 DevOpsCorner Indonesia. All rights reserved.
#
# This workflow builds and releases TelemetryFlow Collector (OCB) for:
# - Linux: RPM (RHEL/CentOS/Fedora), DEB (Debian/Ubuntu)
# - Windows: EXE (64-bit)
# - macOS: DMG (Intel and Apple Silicon)
#
# Build Type: OCB (OpenTelemetry Collector Builder)
# For Standalone build, see release-standalone.yml
#
# Triggers:
# - Push tags matching v*.*.*-ocb
# - Manual workflow dispatch
#
# =============================================================================

name: Release OCB

on:
  push:
    tags:
      - 'v*.*.*-ocb'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      otel_version:
        description: 'OpenTelemetry version (e.g., 0.114.0)'
        required: true
        default: '0.114.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.24'
  BINARY_NAME: tfo-collector-ocb
  PRODUCT_NAME: TelemetryFlow Collector
  BUILD_TYPE: ocb
  OTEL_VERSION: '0.114.0'
  VENDOR: DevOpsCorner Indonesia
  MAINTAINER: support@telemetryflow.id
  DESCRIPTION: Enterprise-grade OpenTelemetry Collector distribution built with OCB
  LICENSE: Apache-2.0
  HOMEPAGE: https://telemetryflow.id

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Prepare Release
  # ===========================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      otel_version: ${{ steps.version.outputs.otel_version }}
      commit: ${{ steps.version.outputs.commit }}
      branch: ${{ steps.version.outputs.branch }}
      build_time: ${{ steps.version.outputs.build_time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            OTEL_VERSION="${{ github.event.inputs.otel_version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            OTEL_VERSION="${{ env.OTEL_VERSION }}"
          fi
          # Always strip -ocb and -standalone suffixes for clean version
          VERSION="${VERSION%-ocb}"
          VERSION="${VERSION%-standalone}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "otel_version=${OTEL_VERSION}" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build Linux Binaries with OCB
  # ===========================================================================
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install OCB
        env:
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          go install go.opentelemetry.io/collector/cmd/builder@v${OTEL_VERSION}

      - name: Build with OCB
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
          COMMIT: ${{ needs.prepare.outputs.commit }}
          BUILD_TIME: ${{ needs.prepare.outputs.build_time }}
        run: |
          mkdir -p dist build/ocb

          # Generate collector code with OCB
          builder --config manifest.yaml --output-path build/ocb

          # Build binary
          cd build/ocb
          CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.goarch }} go build \
            -ldflags "-s -w \
              -X main.Version=${VERSION} \
              -X main.GitCommit=${COMMIT} \
              -X main.BuildTime=${BUILD_TIME} \
              -X main.OtelVersion=${OTEL_VERSION}" \
            -o ../../dist/${{ env.BINARY_NAME }}-linux-${{ matrix.arch }} \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-binary-linux-${{ matrix.arch }}
          path: dist/${{ env.BINARY_NAME }}-linux-${{ matrix.arch }}
          retention-days: 1

  # ===========================================================================
  # Build Windows Binary with OCB
  # ===========================================================================
  build-windows:
    name: Build Windows (amd64)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install OCB
        env:
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          go install go.opentelemetry.io/collector/cmd/builder@v${OTEL_VERSION}

      - name: Build with OCB
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
          COMMIT: ${{ needs.prepare.outputs.commit }}
          BUILD_TIME: ${{ needs.prepare.outputs.build_time }}
        run: |
          mkdir -p dist build/ocb

          # Generate collector code with OCB
          builder --config manifest.yaml --output-path build/ocb

          # Build binary
          cd build/ocb
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build \
            -ldflags "-s -w \
              -X main.Version=${VERSION} \
              -X main.GitCommit=${COMMIT} \
              -X main.BuildTime=${BUILD_TIME} \
              -X main.OtelVersion=${OTEL_VERSION}" \
            -o ../../dist/${{ env.BINARY_NAME }}-windows-amd64.exe \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-binary-windows-amd64
          path: dist/${{ env.BINARY_NAME }}-windows-amd64.exe
          retention-days: 1

  # ===========================================================================
  # Build macOS Binaries with OCB
  # ===========================================================================
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    needs: prepare
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install OCB
        env:
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          go install go.opentelemetry.io/collector/cmd/builder@v${OTEL_VERSION}

      - name: Build with OCB
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
          COMMIT: ${{ needs.prepare.outputs.commit }}
          BUILD_TIME: ${{ needs.prepare.outputs.build_time }}
        run: |
          mkdir -p dist build/ocb

          # Generate collector code with OCB
          builder --config manifest.yaml --output-path build/ocb

          # Build binary
          cd build/ocb
          CGO_ENABLED=0 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
            -ldflags "-s -w \
              -X main.Version=${VERSION} \
              -X main.GitCommit=${COMMIT} \
              -X main.BuildTime=${BUILD_TIME} \
              -X main.OtelVersion=${OTEL_VERSION}" \
            -o ../../dist/${{ env.BINARY_NAME }}-darwin-${{ matrix.arch }} \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-binary-darwin-${{ matrix.arch }}
          path: dist/${{ env.BINARY_NAME }}-darwin-${{ matrix.arch }}
          retention-days: 1

  # ===========================================================================
  # Package RPM
  # ===========================================================================
  package-rpm:
    name: Package RPM (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux]
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            rpm_arch: x86_64
          - arch: arm64
            rpm_arch: aarch64
    steps:
      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ocb-binary-linux-${{ matrix.arch }}
          path: dist

      - name: Create RPM structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/SOURCES/${{ env.BINARY_NAME }}-${VERSION}

          # Copy binary (rename to tfo-collector for consistency)
          cp dist/${{ env.BINARY_NAME }}-linux-${{ matrix.arch }} \
             rpmbuild/SOURCES/${{ env.BINARY_NAME }}-${VERSION}/tfo-collector
          chmod +x rpmbuild/SOURCES/${{ env.BINARY_NAME }}-${VERSION}/tfo-collector

          # Copy config
          mkdir -p rpmbuild/SOURCES/${{ env.BINARY_NAME }}-${VERSION}/configs
          cp configs/ocb-collector.yaml rpmbuild/SOURCES/${{ env.BINARY_NAME }}-${VERSION}/configs/collector.yaml

          # Create tarball
          cd rpmbuild/SOURCES
          tar czf ${{ env.BINARY_NAME }}-${VERSION}.tar.gz ${{ env.BINARY_NAME }}-${VERSION}

      - name: Create RPM spec file
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          # Compute changelog date (RPM requires specific format)
          CHANGELOG_DATE=$(date '+%a %b %d %Y')

          cat > rpmbuild/SPECS/${{ env.BINARY_NAME }}.spec << EOF
          Name:           ${{ env.BINARY_NAME }}
          Version:        ${{ needs.prepare.outputs.version }}
          Release:        1%{?dist}
          Summary:        ${{ env.DESCRIPTION }}
          License:        ${{ env.LICENSE }}
          URL:            ${{ env.HOMEPAGE }}
          Source0:        %{name}-%{version}.tar.gz

          BuildArch:      ${{ matrix.rpm_arch }}
          Conflicts:      tfo-collector

          %description
          ${{ env.PRODUCT_NAME }} (OCB) is an enterprise-grade OpenTelemetry
          Collector distribution built with OpenTelemetry Collector Builder.
          Based on OTEL v${{ needs.prepare.outputs.otel_version }}.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/local/bin
          mkdir -p %{buildroot}/etc/tfo-collector
          mkdir -p %{buildroot}/var/lib/tfo-collector/queue
          mkdir -p %{buildroot}/var/log/tfo-collector
          mkdir -p %{buildroot}/usr/lib/systemd/system

          install -m 755 tfo-collector %{buildroot}/usr/local/bin/
          install -m 644 configs/collector.yaml %{buildroot}/etc/tfo-collector/

          cat > %{buildroot}/usr/lib/systemd/system/tfo-collector.service << 'SYSTEMD'
          [Unit]
          Description=${{ env.PRODUCT_NAME }} (OCB) - Community Enterprise Observability Platform
          Documentation=${{ env.HOMEPAGE }}
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=telemetryflow
          Group=telemetryflow
          ExecStart=/usr/local/bin/tfo-collector --config /etc/tfo-collector/collector.yaml
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=tfo-collector
          LimitNOFILE=65536
          MemoryMax=2G

          [Install]
          WantedBy=multi-user.target
          SYSTEMD

          %pre
          getent group telemetryflow >/dev/null || groupadd -r telemetryflow
          getent passwd telemetryflow >/dev/null || \
            useradd -r -g telemetryflow -d /var/lib/tfo-collector -s /sbin/nologin \
            -c "${{ env.PRODUCT_NAME }}" telemetryflow
          exit 0

          %post
          systemctl daemon-reload

          %preun
          if [ \$1 -eq 0 ]; then
            systemctl stop tfo-collector >/dev/null 2>&1 || :
            systemctl disable tfo-collector >/dev/null 2>&1 || :
          fi

          %postun
          systemctl daemon-reload

          %files
          %defattr(-,root,root,-)
          /usr/local/bin/tfo-collector
          %config(noreplace) /etc/tfo-collector/collector.yaml
          /usr/lib/systemd/system/tfo-collector.service
          %dir /var/lib/tfo-collector
          %dir /var/lib/tfo-collector/queue
          %dir /var/log/tfo-collector

          %changelog
          * ${CHANGELOG_DATE} ${{ env.VENDOR }} <${{ env.MAINTAINER }}> - ${{ needs.prepare.outputs.version }}-1
          - Release version ${{ needs.prepare.outputs.version }} (OCB build, OTEL v${{ needs.prepare.outputs.otel_version }})
          EOF

      - name: Build RPM
        run: |
          rpmbuild --define "_topdir $(pwd)/rpmbuild" \
                   --define "_target_cpu ${{ matrix.rpm_arch }}" \
                   -bb rpmbuild/SPECS/${{ env.BINARY_NAME }}.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-rpm-${{ matrix.arch }}
          path: rpmbuild/RPMS/**/*.rpm
          retention-days: 1

  # ===========================================================================
  # Package DEB
  # ===========================================================================
  package-deb:
    name: Package DEB (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux]
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ocb-binary-linux-${{ matrix.arch }}
          path: dist

      - name: Create DEB structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          PKG_DIR=${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.arch }}
          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/local/bin
          mkdir -p ${PKG_DIR}/etc/tfo-collector
          mkdir -p ${PKG_DIR}/var/lib/tfo-collector/queue
          mkdir -p ${PKG_DIR}/var/log/tfo-collector
          mkdir -p ${PKG_DIR}/lib/systemd/system

          # Copy binary (rename to tfo-collector for consistency)
          cp dist/${{ env.BINARY_NAME }}-linux-${{ matrix.arch }} \
             ${PKG_DIR}/usr/local/bin/tfo-collector
          chmod 755 ${PKG_DIR}/usr/local/bin/tfo-collector

          # Copy config
          cp configs/ocb-collector.yaml ${PKG_DIR}/etc/tfo-collector/collector.yaml

      - name: Create DEB control files
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          PKG_DIR=${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.arch }}

          # Control file
          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: ${{ env.BINARY_NAME }}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: ${{ env.VENDOR }} <${{ env.MAINTAINER }}>
          Description: ${{ env.DESCRIPTION }}
           ${{ env.PRODUCT_NAME }} (OCB) is an enterprise-grade OpenTelemetry
           Collector distribution built with OpenTelemetry Collector Builder.
           Based on OTEL v${OTEL_VERSION}.
          Homepage: ${{ env.HOMEPAGE }}
          Conflicts: tfo-collector
          EOF

          # Pre-install script
          cat > ${PKG_DIR}/DEBIAN/preinst << 'EOF'
          #!/bin/bash
          set -e
          getent group telemetryflow >/dev/null || groupadd -r telemetryflow
          getent passwd telemetryflow >/dev/null || \
            useradd -r -g telemetryflow -d /var/lib/tfo-collector -s /usr/sbin/nologin \
            -c "TelemetryFlow Collector" telemetryflow
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/preinst

          # Post-install script
          cat > ${PKG_DIR}/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          chown -R telemetryflow:telemetryflow /var/lib/tfo-collector
          chown -R telemetryflow:telemetryflow /var/log/tfo-collector
          systemctl daemon-reload
          echo "TelemetryFlow Collector (OCB) installed successfully!"
          echo "To start: sudo systemctl start tfo-collector"
          echo "To enable on boot: sudo systemctl enable tfo-collector"
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/postinst

          # Pre-remove script
          cat > ${PKG_DIR}/DEBIAN/prerm << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "remove" ]; then
            systemctl stop tfo-collector >/dev/null 2>&1 || true
            systemctl disable tfo-collector >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/prerm

          # Post-remove script
          cat > ${PKG_DIR}/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          systemctl daemon-reload
          exit 0
          EOF
          chmod 755 ${PKG_DIR}/DEBIAN/postrm

          # Conffiles
          cat > ${PKG_DIR}/DEBIAN/conffiles << EOF
          /etc/tfo-collector/collector.yaml
          EOF

      - name: Create systemd service
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          PKG_DIR=${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.arch }}
          cat > ${PKG_DIR}/lib/systemd/system/tfo-collector.service << EOF
          [Unit]
          Description=${{ env.PRODUCT_NAME }} (OCB) - Community Enterprise Observability Platform
          Documentation=${{ env.HOMEPAGE }}
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=telemetryflow
          Group=telemetryflow
          ExecStart=/usr/local/bin/tfo-collector --config /etc/tfo-collector/collector.yaml
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=tfo-collector
          LimitNOFILE=65536
          MemoryMax=2G

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Build DEB package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          PKG_DIR=${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.arch }}
          dpkg-deb --build ${PKG_DIR}
          mkdir -p packages
          mv ${PKG_DIR}.deb packages/

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-deb-${{ matrix.arch }}
          path: packages/*.deb
          retention-days: 1

  # ===========================================================================
  # Package Windows EXE
  # ===========================================================================
  package-windows:
    name: Package Windows EXE
    runs-on: ubuntu-latest
    needs: [prepare, build-windows]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ocb-binary-windows-amd64
          path: dist

      - name: Create Windows package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          PKG_DIR=${{ env.BINARY_NAME }}-${VERSION}-windows-amd64
          mkdir -p ${PKG_DIR}

          # Copy binary (rename to tfo-collector for consistency)
          cp dist/${{ env.BINARY_NAME }}-windows-amd64.exe ${PKG_DIR}/tfo-collector.exe

          # Copy config
          cp configs/ocb-collector.yaml ${PKG_DIR}/collector.yaml

          # Create install script
          cat > ${PKG_DIR}/install.ps1 << 'EOF'
          # TelemetryFlow Collector (OCB) Windows Installer
          # Run as Administrator

          $ErrorActionPreference = "Stop"

          $InstallDir = "C:\Program Files\TelemetryFlow\Collector"
          $ConfigDir = "C:\ProgramData\TelemetryFlow\Collector"
          $LogDir = "C:\ProgramData\TelemetryFlow\Collector\logs"
          $QueueDir = "C:\ProgramData\TelemetryFlow\Collector\queue"
          $ServiceName = "TelemetryFlowCollector"

          Write-Host "Installing TelemetryFlow Collector (OCB)..." -ForegroundColor Green

          # Create directories
          New-Item -ItemType Directory -Force -Path $InstallDir | Out-Null
          New-Item -ItemType Directory -Force -Path $ConfigDir | Out-Null
          New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
          New-Item -ItemType Directory -Force -Path $QueueDir | Out-Null

          # Copy files
          Copy-Item -Path ".\tfo-collector.exe" -Destination "$InstallDir\tfo-collector.exe" -Force
          Copy-Item -Path ".\collector.yaml" -Destination "$ConfigDir\collector.yaml" -Force

          # Add to PATH
          $envPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          if ($envPath -notlike "*$InstallDir*") {
              [Environment]::SetEnvironmentVariable("Path", "$envPath;$InstallDir", "Machine")
          }

          # Create Windows Service
          if (Get-Service -Name $ServiceName -ErrorAction SilentlyContinue) {
              Stop-Service -Name $ServiceName -Force
              sc.exe delete $ServiceName
          }

          $binPath = "`"$InstallDir\tfo-collector.exe`" --config `"$ConfigDir\collector.yaml`""
          New-Service -Name $ServiceName `
                      -DisplayName "TelemetryFlow Collector (OCB)" `
                      -Description "TelemetryFlow Collector (OCB) - Community Enterprise Observability Platform" `
                      -BinaryPathName $binPath `
                      -StartupType Automatic

          Write-Host "TelemetryFlow Collector (OCB) installed successfully!" -ForegroundColor Green
          Write-Host "To start: Start-Service $ServiceName" -ForegroundColor Yellow
          Write-Host "To check status: Get-Service $ServiceName" -ForegroundColor Yellow
          EOF

          # Create uninstall script
          cat > ${PKG_DIR}/uninstall.ps1 << 'EOF'
          # TelemetryFlow Collector Windows Uninstaller
          # Run as Administrator

          $ErrorActionPreference = "Stop"

          $InstallDir = "C:\Program Files\TelemetryFlow\Collector"
          $ServiceName = "TelemetryFlowCollector"

          Write-Host "Uninstalling TelemetryFlow Collector..." -ForegroundColor Yellow

          # Stop and remove service
          if (Get-Service -Name $ServiceName -ErrorAction SilentlyContinue) {
              Stop-Service -Name $ServiceName -Force -ErrorAction SilentlyContinue
              sc.exe delete $ServiceName
          }

          # Remove from PATH
          $envPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $newPath = ($envPath.Split(';') | Where-Object { $_ -ne $InstallDir }) -join ';'
          [Environment]::SetEnvironmentVariable("Path", $newPath, "Machine")

          # Remove files
          Remove-Item -Path $InstallDir -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "TelemetryFlow Collector uninstalled successfully!" -ForegroundColor Green
          EOF

          # Create README
          cat > ${PKG_DIR}/README.txt << EOF
          TelemetryFlow Collector v${VERSION} (OCB)
          ==========================================

          Build Type: OCB (OpenTelemetry Collector Builder)
          OTEL Version: ${OTEL_VERSION}

          Installation:
          1. Run PowerShell as Administrator
          2. Navigate to this directory
          3. Run: .\install.ps1

          Manual Usage:
          tfo-collector.exe --config collector.yaml

          Note: OCB build uses standard OTEL CLI (--config instead of start --config)

          Exposed Ports:
          - 4317: OTLP gRPC
          - 4318: OTLP HTTP
          - 8888: Prometheus metrics
          - 8889: Prometheus exporter
          - 13133: Health check
          - 55679: zPages
          - 1777: pprof

          Documentation: https://docs.telemetryflow.id
          Support: support@telemetryflow.id

          Copyright (c) 2024-2026 DevOpsCorner Indonesia
          EOF

          # Create ZIP
          zip -r ${{ env.BINARY_NAME }}-${VERSION}-windows-amd64.zip ${PKG_DIR}

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-windows-amd64
          path: ${{ env.BINARY_NAME }}-*.zip
          retention-days: 1

  # ===========================================================================
  # Package macOS DMG
  # ===========================================================================
  package-macos:
    name: Package macOS DMG (${{ matrix.arch }})
    runs-on: macos-latest
    needs: [prepare, build-macos]
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            macos_arch: x86_64
            display_name: Intel
          - arch: arm64
            macos_arch: arm64
            display_name: Apple Silicon
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ocb-binary-darwin-${{ matrix.arch }}
          path: dist

      - name: Create DMG structure
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OTEL_VERSION: ${{ needs.prepare.outputs.otel_version }}
        run: |
          DMG_DIR="dmg-contents"
          mkdir -p "${DMG_DIR}"

          # Copy binary (rename to tfo-collector for consistency)
          cp dist/${{ env.BINARY_NAME }}-darwin-${{ matrix.arch }} \
             "${DMG_DIR}/tfo-collector"
          chmod +x "${DMG_DIR}/tfo-collector"

          # Copy config
          cp configs/ocb-collector.yaml "${DMG_DIR}/collector.yaml"

          # Create install script
          cat > "${DMG_DIR}/install.sh" << 'EOF'
          #!/bin/bash
          # TelemetryFlow Collector (OCB) macOS Installer

          set -e

          INSTALL_DIR="/usr/local/bin"
          CONFIG_DIR="/etc/tfo-collector"
          DATA_DIR="/var/lib/tfo-collector"
          LOG_DIR="/var/log/tfo-collector"
          LAUNCH_DAEMON="/Library/LaunchDaemons/id.telemetryflow.collector.plist"

          echo "Installing TelemetryFlow Collector (OCB)..."

          # Create directories
          sudo mkdir -p "${CONFIG_DIR}"
          sudo mkdir -p "${DATA_DIR}/queue"
          sudo mkdir -p "${LOG_DIR}"

          # Copy files
          sudo cp tfo-collector "${INSTALL_DIR}/"
          sudo chmod +x "${INSTALL_DIR}/tfo-collector"

          if [ ! -f "${CONFIG_DIR}/collector.yaml" ]; then
            sudo cp collector.yaml "${CONFIG_DIR}/"
          fi

          # Create LaunchDaemon (note: OCB uses --config instead of start --config)
          sudo tee "${LAUNCH_DAEMON}" > /dev/null << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>id.telemetryflow.collector</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/usr/local/bin/tfo-collector</string>
                  <string>--config</string>
                  <string>/etc/tfo-collector/collector.yaml</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>StandardOutPath</key>
              <string>/var/log/tfo-collector/tfo-collector.log</string>
              <key>StandardErrorPath</key>
              <string>/var/log/tfo-collector/tfo-collector-error.log</string>
          </dict>
          </plist>
          PLIST

          echo ""
          echo "TelemetryFlow Collector (OCB) installed successfully!"
          echo ""
          echo "To start the service:"
          echo "  sudo launchctl load ${LAUNCH_DAEMON}"
          echo ""
          echo "To stop the service:"
          echo "  sudo launchctl unload ${LAUNCH_DAEMON}"
          echo ""
          echo "To check status:"
          echo "  sudo launchctl list | grep telemetryflow"
          EOF
          chmod +x "${DMG_DIR}/install.sh"

          # Create uninstall script
          cat > "${DMG_DIR}/uninstall.sh" << 'EOF'
          #!/bin/bash
          # TelemetryFlow Collector macOS Uninstaller

          set -e

          LAUNCH_DAEMON="/Library/LaunchDaemons/id.telemetryflow.collector.plist"

          echo "Uninstalling TelemetryFlow Collector..."

          # Stop service
          if [ -f "${LAUNCH_DAEMON}" ]; then
            sudo launchctl unload "${LAUNCH_DAEMON}" 2>/dev/null || true
            sudo rm -f "${LAUNCH_DAEMON}"
          fi

          # Remove binary
          sudo rm -f /usr/local/bin/tfo-collector

          echo "TelemetryFlow Collector uninstalled successfully!"
          echo "Configuration files are preserved in /etc/tfo-collector/"
          EOF
          chmod +x "${DMG_DIR}/uninstall.sh"

          # Create README
          cat > "${DMG_DIR}/README.txt" << EOF
          TelemetryFlow Collector v${VERSION} (OCB)
          ==========================================
          Architecture: ${{ matrix.display_name }} (${{ matrix.macos_arch }})
          Build Type: OCB (OpenTelemetry Collector Builder)
          OTEL Version: ${OTEL_VERSION}

          Installation:
          1. Open Terminal
          2. Navigate to this directory
          3. Run: ./install.sh

          Manual Usage:
          tfo-collector --config /etc/tfo-collector/collector.yaml

          Note: OCB build uses standard OTEL CLI (--config instead of start --config)

          Exposed Ports:
          - 4317: OTLP gRPC
          - 4318: OTLP HTTP
          - 8888: Prometheus metrics
          - 8889: Prometheus exporter
          - 13133: Health check
          - 55679: zPages
          - 1777: pprof

          Documentation: https://docs.telemetryflow.id
          Support: support@telemetryflow.id

          Copyright (c) 2024-2026 DevOpsCorner Indonesia
          EOF

      - name: Create DMG
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          DMG_NAME="${{ env.BINARY_NAME }}-${VERSION}-darwin-${{ matrix.arch }}.dmg"
          VOLUME_NAME="${{ env.PRODUCT_NAME }} ${VERSION} (OCB)"

          hdiutil create -volname "${VOLUME_NAME}" \
                         -srcfolder "dmg-contents" \
                         -ov -format UDZO \
                         "${DMG_NAME}"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-dmg-${{ matrix.arch }}
          path: ${{ env.BINARY_NAME }}-*.dmg
          retention-days: 1

  # ===========================================================================
  # Create Tarballs
  # ===========================================================================
  package-tarball:
    name: Create Tarball (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-linux, build-macos]
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ocb-binary-${{ matrix.os }}-${{ matrix.arch }}
          path: dist

      - name: Create tarball
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          TAR_DIR="${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "${TAR_DIR}"

          # Copy binary (rename to tfo-collector for consistency)
          cp dist/${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }} \
             "${TAR_DIR}/tfo-collector"
          chmod +x "${TAR_DIR}/tfo-collector"
          cp configs/ocb-collector.yaml "${TAR_DIR}/collector.yaml"
          cp README.md "${TAR_DIR}/" 2>/dev/null || true
          cp LICENSE "${TAR_DIR}/" 2>/dev/null || true

          tar -czvf "${TAR_DIR}.tar.gz" "${TAR_DIR}"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocb-tarball-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ env.BINARY_NAME }}-*.tar.gz
          retention-days: 1

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - package-rpm
      - package-deb
      - package-windows
      - package-macos
      - package-tarball
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ocb-*

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.rpm" -o -name "*.deb" -o -name "*.zip" -o -name "*.dmg" -o -name "*.tar.gz" \) \
            -exec cp {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.PRODUCT_NAME }} v${{ needs.prepare.outputs.version }} (OCB)"
          tag_name: "v${{ needs.prepare.outputs.version }}-ocb"
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            release/*
          body: |
            ## ${{ env.PRODUCT_NAME }} v${{ needs.prepare.outputs.version }} (OCB Build)

            **Build Type:** OCB (OpenTelemetry Collector Builder)
            **OTEL Version:** ${{ needs.prepare.outputs.otel_version }}

            This is the OCB build using the OpenTelemetry Collector Builder with the full OTEL ecosystem.
            For the standalone build with custom Cobra CLI, see the `-standalone` release.

            ### Downloads

            | Platform | Architecture | Package |
            |----------|--------------|---------|
            | Linux | amd64 | RPM, DEB, tar.gz |
            | Linux | arm64 | RPM, DEB, tar.gz |
            | Windows | amd64 | ZIP (with installer) |
            | macOS | Intel (amd64) | DMG, tar.gz |
            | macOS | Apple Silicon (arm64) | DMG, tar.gz |

            ### Installation

            **Linux (DEB):**
            ```bash
            sudo dpkg -i tfo-collector-ocb_${{ needs.prepare.outputs.version }}_amd64.deb
            sudo systemctl start tfo-collector
            ```

            **Linux (RPM):**
            ```bash
            sudo rpm -i tfo-collector-ocb-${{ needs.prepare.outputs.version }}-1.x86_64.rpm
            sudo systemctl start tfo-collector
            ```

            **macOS:**
            1. Open the DMG file
            2. Run `./install.sh` in Terminal

            **Windows:**
            1. Extract the ZIP file
            2. Run `install.ps1` as Administrator

            ### CLI Difference

            | Build Type | Start Command |
            |------------|---------------|
            | Standalone | `tfo-collector start --config config.yaml` |
            | OCB | `tfo-collector --config config.yaml` |

            ### Exposed Ports

            | Port | Description |
            |------|-------------|
            | 4317 | OTLP gRPC |
            | 4318 | OTLP HTTP |
            | 8888 | Prometheus metrics |
            | 8889 | Prometheus exporter |
            | 13133 | Health check |
            | 55679 | zPages |
            | 1777 | pprof |

            ### Verification

            Verify downloads using SHA256 checksums in `checksums-sha256.txt`.

            ---

            üìö [Documentation](https://docs.telemetryflow.id) | üêõ [Report Issues](https://github.com/telemetryflow/telemetryflow-collector/issues)
